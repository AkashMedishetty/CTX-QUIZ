#!/bin/bash
# =============================================================================
# CTX Quiz - Deployment CLI
# =============================================================================
# Vercel-like deployment commands for managing CTX Quiz deployments
#
# Usage:
#   ctx-deploy list              - List all deployments
#   ctx-deploy status            - Show current deployment status
#   ctx-deploy rollback <id>     - Rollback to specific deployment
#   ctx-deploy rollback          - Rollback to previous deployment
#   ctx-deploy logs              - Show deployment logs
#   ctx-deploy health            - Check service health
# =============================================================================

set -e

# Configuration
DEPLOY_DIR="/opt/ctx-quiz"
DEPLOYMENTS_DIR="$DEPLOY_DIR/deployments"
CURRENT_LINK="$DEPLOY_DIR/current"
DOMAIN="vm701294211.manageserver.in"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# =============================================================================
# Helper Functions
# =============================================================================

print_logo() {
    echo ""
    echo -e "${CYAN}   _____ _______  __   ___        _     ${NC}"
    echo -e "${CYAN}  / ____|__   __| \ \ / / |      (_)    ${NC}"
    echo -e "${CYAN} | |       | |     \ V /| |_ __ _ _ ____${NC}"
    echo -e "${CYAN} | |       | |      > < | | '_ \` | |_  /${NC}"
    echo -e "${CYAN} | |____   | |     / . \| | | | | |/ / ${NC}"
    echo -e "${CYAN}  \_____|  |_|    /_/ \_\_|_| |_|_/___|${NC}"
    echo ""
    echo -e "${BLUE}  Deployment Management CLI${NC}"
    echo ""
}

# =============================================================================
# Commands
# =============================================================================

cmd_list() {
    print_logo
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}                           Available Deployments                            ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    CURRENT_DEPLOY=""
    if [ -L "$CURRENT_LINK" ]; then
        CURRENT_DEPLOY=$(basename "$(readlink -f "$CURRENT_LINK")")
    fi
    
    printf "  ${BLUE}%-45s${NC} ${BLUE}%-20s${NC} ${BLUE}%-10s${NC}\n" "DEPLOYMENT ID" "CREATED" "STATUS"
    echo "  ─────────────────────────────────────────────────────────────────────────"
    
    ls -1t "$DEPLOYMENTS_DIR" 2>/dev/null | while read DEPLOY; do
        METADATA_FILE="$DEPLOYMENTS_DIR/$DEPLOY/metadata.json"
        
        if [ -f "$METADATA_FILE" ]; then
            CREATED=$(jq -r '.created_at' "$METADATA_FILE" 2>/dev/null | cut -d'T' -f1)
        else
            CREATED=$(stat -c %y "$DEPLOYMENTS_DIR/$DEPLOY" 2>/dev/null | cut -d' ' -f1)
        fi
        
        if [ "$DEPLOY" = "$CURRENT_DEPLOY" ]; then
            STATUS="${GREEN}● ACTIVE${NC}"
        else
            STATUS="${YELLOW}○ Ready${NC}"
        fi
        
        printf "  %-45s %-20s " "$DEPLOY" "$CREATED"
        echo -e "$STATUS"
    done
    
    echo ""
}

cmd_status() {
    print_logo
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}                           Deployment Status                                ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Current deployment
    if [ -L "$CURRENT_LINK" ]; then
        CURRENT_DEPLOY=$(basename "$(readlink -f "$CURRENT_LINK")")
        echo -e "  ${BLUE}Current Deployment:${NC}  ${GREEN}$CURRENT_DEPLOY${NC}"
    else
        echo -e "  ${BLUE}Current Deployment:${NC}  ${RED}None${NC}"
    fi
    
    echo -e "  ${BLUE}Domain:${NC}              https://$DOMAIN"
    echo ""
    
    # Service status
    echo -e "  ${BLUE}Services:${NC}"
    echo ""
    
    for SERVICE in ctx-nginx ctx-backend ctx-frontend ctx-mongodb ctx-redis; do
        STATUS=$(docker inspect -f '{{.State.Status}}' "$SERVICE" 2>/dev/null || echo "not found")
        HEALTH=$(docker inspect -f '{{.State.Health.Status}}' "$SERVICE" 2>/dev/null || echo "N/A")
        
        if [ "$STATUS" = "running" ]; then
            if [ "$HEALTH" = "healthy" ]; then
                echo -e "    ${GREEN}●${NC} $SERVICE: ${GREEN}running (healthy)${NC}"
            elif [ "$HEALTH" = "N/A" ]; then
                echo -e "    ${GREEN}●${NC} $SERVICE: ${GREEN}running${NC}"
            else
                echo -e "    ${YELLOW}●${NC} $SERVICE: ${YELLOW}running ($HEALTH)${NC}"
            fi
        else
            echo -e "    ${RED}●${NC} $SERVICE: ${RED}$STATUS${NC}"
        fi
    done
    
    echo ""
    
    # Health check
    echo -e "  ${BLUE}Health Check:${NC}"
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/api/health" 2>/dev/null || echo "000")
    
    if [ "$HTTP_STATUS" = "200" ]; then
        echo -e "    ${GREEN}✓${NC} API responding (HTTP $HTTP_STATUS)"
    else
        echo -e "    ${RED}✗${NC} API not responding (HTTP $HTTP_STATUS)"
    fi
    
    echo ""
}

cmd_rollback() {
    local TARGET="$1"
    
    print_logo
    
    if [ -z "$TARGET" ]; then
        # Rollback to previous
        if [ -L "$CURRENT_LINK" ]; then
            CURRENT_DEPLOY=$(basename "$(readlink -f "$CURRENT_LINK")")
            TARGET=$(ls -1t "$DEPLOYMENTS_DIR" 2>/dev/null | grep -v "^$CURRENT_DEPLOY$" | head -1)
        fi
        
        if [ -z "$TARGET" ]; then
            echo -e "${RED}❌ No previous deployment found${NC}"
            exit 1
        fi
    fi
    
    if [ ! -d "$DEPLOYMENTS_DIR/$TARGET" ]; then
        echo -e "${RED}❌ Deployment not found: $TARGET${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}⚠️  Rolling back to: $TARGET${NC}"
    echo ""
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$DEPLOY_DIR"
        ./deploy/atomic-deploy.sh --deployment-id "$TARGET" --rollback
        echo ""
        echo -e "${GREEN}✅ Rollback complete!${NC}"
    else
        echo -e "${YELLOW}Rollback cancelled${NC}"
    fi
}

cmd_logs() {
    local SERVICE="${1:-backend}"
    
    print_logo
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}                           Logs: ctx-$SERVICE                               ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    docker logs --tail 100 -f "ctx-$SERVICE" 2>&1
}

cmd_health() {
    print_logo
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}                           Health Check                                     ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # API Health
    echo -e "  ${BLUE}API Health:${NC}"
    HEALTH_RESPONSE=$(curl -s "https://$DOMAIN/api/health" 2>/dev/null)
    
    if [ -n "$HEALTH_RESPONSE" ]; then
        echo "$HEALTH_RESPONSE" | jq -r '
            "    Status: \(.status // "unknown")",
            "    Uptime: \(.uptime // "unknown")s",
            "    MongoDB: \(.mongodb // "unknown")",
            "    Redis: \(.redis // "unknown")"
        ' 2>/dev/null || echo "    $HEALTH_RESPONSE"
    else
        echo -e "    ${RED}API not responding${NC}"
    fi
    
    echo ""
    
    # Resource usage
    echo -e "  ${BLUE}Resource Usage:${NC}"
    docker stats --no-stream --format "    {{.Name}}: CPU {{.CPUPerc}}, Memory {{.MemUsage}}" \
        ctx-backend ctx-frontend ctx-mongodb ctx-redis ctx-nginx 2>/dev/null || echo "    Unable to get stats"
    
    echo ""
}

cmd_help() {
    print_logo
    echo -e "${CYAN}Usage:${NC} ctx-deploy <command> [options]"
    echo ""
    echo -e "${CYAN}Commands:${NC}"
    echo "  list              List all available deployments"
    echo "  status            Show current deployment status"
    echo "  rollback [id]     Rollback to specific or previous deployment"
    echo "  logs [service]    Show logs (backend, frontend, nginx, mongodb, redis)"
    echo "  health            Check service health"
    echo "  help              Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  ctx-deploy list"
    echo "  ctx-deploy rollback deploy-20240115-123456-abc12345"
    echo "  ctx-deploy logs backend"
    echo ""
}

# =============================================================================
# Main
# =============================================================================

case "${1:-help}" in
    list)       cmd_list ;;
    status)     cmd_status ;;
    rollback)   cmd_rollback "$2" ;;
    logs)       cmd_logs "$2" ;;
    health)     cmd_health ;;
    help|--help|-h) cmd_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        cmd_help
        exit 1
        ;;
esac
