version: '3.8'

services:
  # MongoDB (for local development)
  mongodb:
    image: mongo:7
    container_name: quiz-mongodb
    restart: unless-stopped
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: quiz_platform
    volumes:
      - mongodb_data:/data/db
    networks:
      - quiz-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: quiz-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - quiz-network

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: quiz-backend
    restart: unless-stopped
    ports:
      - '3001:3001'
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: mongodb://admin:password@mongodb:27017/quiz_platform?authSource=admin
      REDIS_URL: redis://redis:6379
      FRONTEND_URL: http://localhost:3000
    depends_on:
      - mongodb
      - redis
    networks:
      - quiz-network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: quiz-frontend
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://localhost:3001
      NEXT_PUBLIC_WS_URL: http://localhost:3001
    depends_on:
      - backend
    networks:
      - quiz-network

  # Nginx (reverse proxy with SSL termination)
  nginx:
    image: nginx:alpine
    container_name: quiz-nginx
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL certificates - mount your certificates here
      # For Let's Encrypt: ./ssl/certbot/conf:/etc/letsencrypt:ro
      # For self-signed/commercial: ./ssl:/etc/nginx/ssl:ro
      - ./ssl:/etc/nginx/ssl:ro
      # Let's Encrypt webroot for ACME challenges
      - ./ssl/certbot/www:/var/www/certbot:ro
    depends_on:
      - backend
      - frontend
    networks:
      - quiz-network

  # Certbot for automatic SSL certificate renewal (optional - for Let's Encrypt)
  # Uncomment this service when using Let's Encrypt certificates
  # certbot:
  #   image: certbot/certbot
  #   container_name: quiz-certbot
  #   volumes:
  #     - ./ssl/certbot/conf:/etc/letsencrypt
  #     - ./ssl/certbot/www:/var/www/certbot
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  #   networks:
  #     - quiz-network

volumes:
  mongodb_data:
  redis_data:

networks:
  quiz-network:
    driver: bridge
